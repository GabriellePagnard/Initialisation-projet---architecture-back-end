# Mise en place architecture #

üö®üö®üö® Bien veiller √† modifier le chemin d'acc√®s des fichiers üö®üö®üö®

## 1. Initialiser le package.json ##

‚û°Ô∏è Commande : `npm init` 

=> Permet d'installer les d√©pendances du projet en initialisant Node.js

## 2. Installer les modules n√©cessaires au projet ##

### A. Express ###

‚û°Ô∏è Commande : `npm i express`

=> Permet de cr√©er un serveur web, de mieux organiser et structurer son code et de gagner du temps en fournissant des outils pr√™ts √† l'emploi pour g√©rer les t√¢ches courantes comme la gestion des requ√™tes et des r√©ponses HTT

### B. EJS ###

‚û°Ô∏è Commande : `npm i ejs`

=> Permet de cr√©er les vues .ejs et donc g√©n√©rer des pages HTML dynamiques

### C. PG ###

‚û°Ô∏è Commande : `npm i pg`

=> Permet d'avoir une base de donn√©es locale pour stocker des donn√©es, faciliter la gestion des donn√©es stock√©es, permettre des requ√™tes efficaces et de b√©n√©ficier d'une s√©curit√© renforc√©e pour les donn√©es.
*On doit l'installer dans un projet Javascript si on utilise une base de donn√©es SQL avec notre application*.

### D. Sequelize ###

‚û°Ô∏è Commande : `npm i sequelize`

=> Permet :
Sequelize est une biblioth√®que d'ORM (Object Relational Mapping) pour Node.js et Javascript. Elle permet de faciliter la communication entre une base de donn√©es SQL et une application Javascript. Elle propose des fonctionnalit√©s telles que la cr√©ation de table, les associations entre tables, la validation des donn√©es et les requ√™tes SQL.

*On doit l'installer dans un projet Javascript si on utilise une base de donn√©es SQL avec notre application*. Sequelize automatise l'acc√®s √† la base de donn√©es et permet de faciliter les op√©rations li√©es √† la cr√©ation, la mise √† jour ou la suppression des donn√©es dans la base de donn√©es. Elle offre √©galement une syntaxe simplifi√©e pour les requ√™tes SQL. Cela permet ainsi de gagner √©norm√©ment de temps et d'efforts dans le d√©veloppement de l'application.

### E. Dotenv ###

‚û°Ô∏è Commande : `npm i dotenv`

=> Permet d'utiliser les variables contenues dans le fichier .env 

## 3. Cr√©ation du fichier .gitignore ##

‚û°Ô∏è Cr√©er un fichier .gitignore pour ne pas versionner le .env ni les modules de node

=> noter dedans :

- node_modules/
- .env

## 4. Installer des d√©pendances de d√©veloppement ##

### Nodemon ###

‚û°Ô∏è Commande : `npm install --save-dev nodemon` (pour installer nodemon lorsqu'on est sur une machine de developpement)


### Eslint ###

‚û°Ô∏è Commande : `npm install --save-dev eslint`

=> Eslint permet d'analyser le code en temps r√©√©l et de pointer les erreures √©ventuelles selon la configuration de Eslint qui aura √©t√© faite

‚ö†Ô∏è‚ö†Ô∏è Quans on r√©cup√®re un code o√π il y a d√©j√† eu d'installer express, ejs, etc..., il est inutile de tout r√©installer, si ils sont pr√©sent dans le fichier JSON, il suffit de taper la commande `npm install` ‚ö†Ô∏è‚ö†Ô∏è

## 5. Cr√©ation du fichier .env ##

Cr√©er un fichier .env ‚û°Ô∏è‚û°Ô∏è ‚ö†Ô∏è LE METTRE A LA RACINE DU PROJET !! ‚ö†Ô∏è
et y mettre les informations sensibles qu'on ne veut pas diffuser (nom d'utilisateur BDD + mot de passe ou num√©ro de port sur le localhost par exemple) :

- PORT=[leNum√©roDePortAUtiliser]
- PG_URL=postgres://oquiz:oquiz:@localhost:3000/bddoquiz
- DB_DIALECT=postgres

Si on utilise pas sequelize, pr√©f√©rer plut√¥t :

PG_URI=postgres://oquiz:oquiz:@localhost:3000/bddoquiz

## 6. Cr√©ation du dossier Data ##

Cr√©er le dossier data et y mettre les fichiers .sql (les fichiers de scripts de cr√©ation des tables de la/des BDD)

## 7. Mise en place de la BDD ##

### A. Se connecter √† la base avec psql en tant que super utilisateur ###

‚û°Ô∏è Commande : `sudo -i -u postgres psql`

On devrait se retrouver avec une invite de commande qui ressemble √† √ßa : `postgres=#`

### B. Cr√©er un utilisateur de BDD (~ administrateur de la BDD) ###

‚û°Ô∏è Commande : `CREATE USER nomDuLutilisateur WITH PASSWORD 'motDePasse';`

### C. Cr√©er la base de donn√©es ###

‚û°Ô∏è Commande : `CREATE DATABASE nomDeLaBase OWNER nomDuLutilisateur;`

   üö® Le mot **OWNER** signifie **Propri√©taire** qui est ici notre **utilisateur** cr√©e pr√©c√©dement üö®   

‚ö†Ô∏è‚ö†Ô∏è Penser √† se d√©connecter imm√©diatement car il est dangereux de rester trop longtemps connect√© en tant que super utilisateur √† une BDD (un accident est vite arriv√©) ‚ö†Ô∏è‚ö†Ô∏è

‚û°Ô∏è Commande pour se d√©connecter : `Ctrl` + `d`

### D. Tester la connexion √† la base de donn√©es ###

Relancer psql avec l'utilisateur qu'on vient de cr√©er en lui demandant de se connecter √† la BDD qu'on vient de cr√©er

‚û°Ô∏è Commande pour lancer psql avec un utilisateur pr√©cis :

`psql -U nomDeLutilisateur -d nomDeLaBase`

‚û°Ô∏è‚û°Ô∏è Le terminal va demander d'entrer le mot de passe de l'utilisateur qu'on a cr√©√© pr√©c√©demment

On devrait se retrouver avec une invite de commande qui dit √ßa :
`nomDeLaBase=>`
C‚Äôest que psql s‚Äôest connect√© avec succ√®s √† la base qu'on vient de cr√©er

‚û°Ô∏è‚û°Ô∏è On peut re-quitter psql avec `Ctrl` + `d` pour retrouver notre terminal classique.

### E. Ex√©cuter un script SQL sur une base de donn√©es ###

‚û°Ô∏è Commande :
`psql -U numUtilisateur -d nomBaseDeDonnees -f chemin/du/fichier.sql`
=> Permet d'ex√©cuter un ensemble de commandes SQL stock√©es dans un fichier sur une base pr√©cise

## 8. Cr√©er un fichier index.js ##

Cr√©er le fichier index.js ou app.js et utiliser les modules qu'on a install√© :

### A. Importer les modules n√©cessaires ###

‚ö†Ô∏è A METTRE TOUT EN HAUT DU FICHIER (PREMIERE LIGNE) ‚ö†Ô∏è :

```
require("dotenv").config();
```

### B. Importer les d√©pendances externes ###
  
  ```
  const express = require('express');
  ```

### C. Importer des d√©pendances internes ###

  ```
  const router = require("./src/router");
  const middleware404 = require("./src/middlewares/middleware404");
  ```

### D. Cr√©ation de l'app express ###

  ```
  const app = express();
  ```

### E. Configuration de l'application express ###

  1. Configuration du moteur de rendu de vues :

    app.set("view engine", "ejs");
    app.set("views", "./src/views");

  2. D√©finition du dossier public (on peut aussi l'appeler "static" par exemple) pour les fichiers statiques :

    app.use(express.static("./public"));
    
‚û°Ô∏è‚û°Ô∏è‚û°Ô∏è objectif : les fichiers dans le dossier public seront accessible par leur nom de fichier sans avoir √† coder la moindre route !

### F. Brancher le routeur (d√®s qu'on aura cr√©√© le fichier router) ###

  ```
  app.use(router);
  ```

### G. D√©finir la page 404 via le middleware ###

  ```
  app.use(middleware404);
  ```

### H. Lancement de l'application ###

```
  const port = process.env.PORT || 3000;
  app.listen(port, () => {
  console.log(`Listening on http://localhost:${port}`);
});
```

## 9. Cr√©er un dossier pour les vues et les fichiers EJS n√©cessaires pour le projet ##

1. Cr√©er un dossier views
2. Dans le dossier views, cr√©er les fichiers EJS n√©cessaires :

- 404.ejs
- home.ejs
- etc...

## 10. Cr√©ation du dossier middleware et des premiers middlewares ##

## 11. Cr√©ation du dossier partials dans le dossier views et factorisation des header, footer et nav barre ##

Voir exemple fourni ci-contre pour avoir la structure de base d'un header, d'une nav barre et d'un footer

## 12. Cr√©ation du dossier controllers et cr√©ation des premiers controlers ##

1. Cr√©er un dossier controllers
2. Dans le dossier controllers, cr√©er les controllers au fur et √† mesure des besoins :

- mainController.js
- etc...

## 13. Cr√©ation du fichier router et cr√©ation des premi√®res routes ##

1. Cr√©er un fichier router.js
2. Y faire figurer :

### A. Importation des modules n√©cessaires ###

EX:

```
const { Level } = require("../models"); 
```

‚û°Ô∏è‚û°Ô∏è‚û°Ô∏è Permet d'importer le fichier "level" en passant par le chemin indiqu√© dans le "fichier passe plat" (index.js du dossier models)

### B. Route pour afficher la page "level" par exemple" ###

```
const levelController = {
  async renderLevelsPage(req, res) {
    const levels = await Level.findAll();

    res.render("levels", { levels });
  }
};
```

### C. Exporter le fichier pour que √ßa fonctionne ###

```
module.exports = levelController;
```

### D. Cr√©er les fichiers correspondants (les diff√©rentes pages, les controllers, etc...) ###

## 14. Mise en place des mod√®les de donn√©es avec sequelize #

1. Cr√©er un dossier models pour y stocker les mod√®les
2. Cr√©er un fichier sequelize-connection.js et importer dedans les modules n√©cessaires :

### A. Importer les modules n√©cessaires ###

‚ö†Ô∏è A METTRE TOUT EN HAUT DU FICHIER (PREMIERE LIGNE) ‚ö†Ô∏è :
  
  ```
  require("dotenv").config();
  ```

### B. Initialiser une connexion √† la base de donn√©es PostgreSQL en utilisant les variables d'environnement sp√©cifi√©es dans le fichier .env et on modifie le mapping des mod√®les ###

```
const sequelize = new Sequelize(process.env.PG_URL, {
  dialect: process.env.DB_DIALECT,

  define: {
    createdAt: "created_at", // Pour TOUS nos mod√®les, on modifie le mapping par d√©faut du created_at
    updatedAt: "updated_at"
  }
});
```

### C. Pour tester que la connexion se passe bien et que tout est ok ###

```
sequelize.authenticate().then(() => { console.log("OK"); }).catch((error) => { console.error(error); });
```

### D. Exporter l'objet Sequelize pour qu'il soit utilis√© dans d'autres parties du code ###

```
module.exports = sequelize;
```

3. Cr√©er un fichier index.js qui sera le ""fichier "passe-plat" dans lequel on stockera tous les chemins d'acc√®s √† nos mod√®les
4. Cr√©er un fichier par mod√®le (ex : Level.js, User.js)
5. Cr√©er un fichier par test (ex : test-level.js, test-user.js)
   Ne pas oublier de require le fichier auquel il se rapporte tout en haut (la premi√®re ligne)

## 15. Cr√©ation du dossier public et des dossiers qu'il contient ##

### A. Cr√©ation du dossier css ###

‚û°Ô∏è‚û°Ô∏è‚û°Ô∏è Il contiendra le fichier reset.css et le fichier style.css

### B. Cr√©ation du fichier images ###

‚û°Ô∏è‚û°Ô∏è‚û°Ô∏è Il contiendra les images qu'on utisera sur le site

## 16. Cr√©ation des scripts pour le fichier JSON - Optionnel - ##

Dans le fichier packaga.json, cr√©er des scripts :

ex :

```
"scripts": {
    "start": "node index.js", ===> permettra de lancer "node index.js" √† la commande "start"
    "dev": "nodemon index.js",
    "db:create": "psql -U oquiz -d oquiz -f ./data/create_tables.sql",
    "db:populate": "psql -U oquiz -d oquiz -f ./data/populate_tables.sql",
    "db:reset": "npm run db:create && npm run db:populate",
    "db:connect": "psql -U oquiz -d oquiz"
},
```

- `"start": "node index.js"` ‚û°Ô∏è permettra de lancer `node index.js` √† la commande `npm run start`
- `"dev": "nodemon index.js"` ‚û°Ô∏è permettra de lancer `nodemon index.js` √† la commande `npm run dev`
=> Permet de relancer automatiquement le serveur √† chaque fois qu'on enregistre le fichier
- `"db:create": "psql -U oquiz -d oquiz -f ./data/create_tables.sql"` ‚û°Ô∏è permettra de lancer la commande `psql -U oquiz -d oquiz -f ./data/create_tables.sql` √† la commande `npm run db:create`
- `"db:populate": "psql -U oquiz -d oquiz -f ./data/populate_tables.sql"` ‚û°Ô∏è permettra d'injecter les √©l√©ments de la table `psql -U oquiz -d oquiz -f ./data/populate_tables.sql` √† la commande `npm run db:populate`
üö®üö® Une fois qu'on a ex√©cuter cette commende, ne surtout plus la r√©√©xecuter car ca risquerait de r√©initialiser totalement la BDD (**en fonction du code de la base**) üö®üö®
- `"db:reset": "npm run db:create && npm run db:populate"` ‚û°Ô∏è permettra de lancer `npm run db:create && npm run db:populate` √† la commande `nom run db:reset`
- `"db:connect": "psql -U oquiz -d oquiz"` ‚û°Ô∏è permettra de lancer `psql -U oquiz -d oquiz` √† la commande `nom run db:connect`
